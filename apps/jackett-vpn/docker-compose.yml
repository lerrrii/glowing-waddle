version: "3.7"
services:
  jackett-vpn:
    image: dyonr/jackettvpn:latest
    container_name: jackett-vpn
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
    privileged: true
    environment:
      - PUID=${PUID-1000}
      - PGID=${PGID-1000}
      - TZ=${TZ}
      - VPN_ENABLED=${VPN_ENABLED-yes}
      - VPN_TYPE=${VPN_TYPE-wireguard}
      - LAN_NETWORK=${LAN_NETWORK-192.168.0.0/16,172.16.0.0/12,10.0.0.0/8}
      - NAME_SERVERS=${NAME_SERVERS-1.1.1.1,1.0.0.1}
      - UMASK=${UMASK-002}
      - VPN_USERNAME=${VPN_USERNAME}
      - VPN_PASSWORD=${VPN_PASSWORD}
    volumes:
      - ${APP_DATA_DIR}/data:/config
      - ${APP_DATA_DIR}/data/wireguard:/config/wireguard
      - ${APP_DATA_DIR}/data/openvpn:/config/openvpn
      - ${ROOT_FOLDER_HOST}/media/torrents:/blackhole
    ports:
      - ${APP_PORT}:9117
    restart: unless-stopped
    networks:
      - tipi_main_network
    labels:
      # Main
      traefik.enable: true
      traefik.http.middlewares.jackett-vpn-web-redirect.redirectscheme.scheme: https
      traefik.http.services.jackett-vpn.loadbalancer.server.port: 9117
      # Web
      traefik.http.routers.jackett-vpn-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.jackett-vpn-insecure.entrypoints: web
      traefik.http.routers.jackett-vpn-insecure.service: jackett-vpn
      traefik.http.routers.jackett-vpn-insecure.middlewares: jackett-vpn-web-redirect
      # Websecure
      traefik.http.routers.jackett-vpn.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.jackett-vpn.entrypoints: websecure
      traefik.http.routers.jackett-vpn.service: jackett-vpn
      traefik.http.routers.jackett-vpn.tls.certresolver: myresolver
      # Local domain
      traefik.http.routers.jackett-vpn-local-insecure.rule: Host(`jackett-vpn.${LOCAL_DOMAIN}`)
      traefik.http.routers.jackett-vpn-local-insecure.entrypoints: web
      traefik.http.routers.jackett-vpn-local-insecure.service: jackett-vpn
      traefik.http.routers.jackett-vpn-local-insecure.middlewares: jackett-vpn-web-redirect
      # Local domain secure
      traefik.http.routers.jackett-vpn-local.rule: Host(`jackett-vpn.${LOCAL_DOMAIN}`)
      traefik.http.routers.jackett-vpn-local.entrypoints: websecure
      traefik.http.routers.jackett-vpn-local.service: jackett-vpn
      traefik.http.routers.jackett-vpn-local.tls: true
      runtipi.managed: true

networks:
  tipi_main_network:
    external: true
