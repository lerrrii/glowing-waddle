version: "3.7"

services:
  czstreams:
    build:
      context: ${APP_DATA_DIR}/data
      dockerfile: Dockerfile
    container_name: czstreams
    restart: unless-stopped
    
    volumes:
      # Mount data directory for runtime file changes (if needed)
      - ${APP_DATA_DIR}/data:/app
    
    ports:
      - ${APP_PORT}:52932
    
    environment:
      - PORT=52932
    
    networks:
      - tipi_main_network
    
    labels:
      # Main service configuration
      traefik.enable: true
      traefik.http.middlewares.czstreams-web-redirect.redirectscheme.scheme: https
      traefik.http.services.czstreams.loadbalancer.server.port: 52932
      
      # Web (insecure HTTP)
      traefik.http.routers.czstreams-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.czstreams-insecure.entrypoints: web
      traefik.http.routers.czstreams-insecure.service: czstreams
      traefik.http.routers.czstreams-insecure.middlewares: czstreams-web-redirect
      
      # Websecure (HTTPS with public domain)
      traefik.http.routers.czstreams.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.czstreams.entrypoints: websecure
      traefik.http.routers.czstreams.service: czstreams
      traefik.http.routers.czstreams.tls.certresolver: myresolver
      
      # Local domain (insecure HTTP)
      traefik.http.routers.czstreams-local-insecure.rule: Host(`czstreams.${LOCAL_DOMAIN}`)
      traefik.http.routers.czstreams-local-insecure.entrypoints: web
      traefik.http.routers.czstreams-local-insecure.service: czstreams
      traefik.http.routers.czstreams-local-insecure.middlewares: czstreams-web-redirect
      
      # Local domain (secure HTTPS)
      traefik.http.routers.czstreams-local.rule: Host(`czstreams.${LOCAL_DOMAIN}`)
      traefik.http.routers.czstreams-local.entrypoints: websecure
      traefik.http.routers.czstreams-local.service: czstreams
      traefik.http.routers.czstreams-local.tls: true
      
      # Runtipi management label
      runtipi.managed: true

networks:
  tipi_main_network:
    external: true
