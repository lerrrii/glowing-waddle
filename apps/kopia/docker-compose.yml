version: '3.7'

services:
  kopia:
    image: kopia/kopia:latest
    container_name: kopia-server
    hostname: ${KOPIA_HOSTNAME:-kopia-server}
    restart: unless-stopped
    environment:
      - TZ=${TZ:-Europe/Prague}
      - PUID=${KOPIA_PUID:-1000}
      - PGID=${KOPIA_PGID:-1000}
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - KOPIA_SERVER_USERNAME=${KOPIA_SERVER_USERNAME:-admin}
      - KOPIA_SERVER_PASSWORD=${KOPIA_SERVER_PASSWORD}
    ports:
      - ${APP_PORT:-51515}:51515
    volumes:
      - ${APP_DATA_DIR}/data/config:/app/config
      - ${APP_DATA_DIR}/data/cache:/app/cache
      - ${APP_DATA_DIR}/data/logs:/app/logs
      - ${APP_DATA_DIR}/data/repository:/repository
      - ${APP_DATA_DIR}/data/snapshots:/tmp:shared
      - /:/data:ro
    command:
      - server
      - start
      - --disable-csrf-token-checks
      - --insecure
      - --address=0.0.0.0:51515
      - --server-username=${KOPIA_SERVER_USERNAME}
      - --server-password=${KOPIA_SERVER_PASSWORD}
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    networks:
      - tipi_main_network
    labels:
      traefik.enable: true
      # HTTP -> HTTPS redirect
      traefik.http.middlewares.kopia-web-redirect.redirectscheme.scheme: https
      # Insecure (HTTP) router
      traefik.http.routers.kopia-insecure.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.kopia-insecure.entrypoints: web
      traefik.http.routers.kopia-insecure.middlewares: kopia-web-redirect
      traefik.http.routers.kopia-insecure.service: kopia
      # Secure (HTTPS) router
      traefik.http.routers.kopia.rule: Host(`${APP_DOMAIN}`)
      traefik.http.routers.kopia.entrypoints: websecure
      traefik.http.routers.kopia.tls.certresolver: myresolver
      traefik.http.routers.kopia.service: kopia
      # Local-dev HTTP router
      traefik.http.routers.kopia-local-insecure.rule: Host(`kopia.${LOCAL_DOMAIN}`)
      traefik.http.routers.kopia-local-insecure.entrypoints: web
      traefik.http.routers.kopia-local-insecure.middlewares: kopia-web-redirect
      traefik.http.routers.kopia-local-insecure.service: kopia
      # Local-dev HTTPS router
      traefik.http.routers.kopia-local.rule: Host(`kopia.${LOCAL_DOMAIN}`)
      traefik.http.routers.kopia-local.entrypoints: websecure
      traefik.http.routers.kopia-local.tls: true
      traefik.http.routers.kopia-local.service: kopia
      runtipi.managed: true

networks:
  tipi_main_network:
    external: true
