{
  "$schema": "../dynamic-compose-schema.json",
  "services": [
    {
      "name": "kopia",
      "image": "kopia/kopia:latest",
      "isMain": true,
      "hostname": "${KOPIA_HOSTNAME:-kopia-server}",
      "internalPort": 51515,
      "environment": {
        "PUID": "${KOPIA_PUID:-1000}",
        "PGID": "${KOPIA_PGID:-1000}",
        "TZ": "${TZ:-Europe/Prague}",
        "KOPIA_PASSWORD": "${KOPIA_PASSWORD}",
        "KOPIA_SERVER_USERNAME": "${KOPIA_SERVER_USERNAME:-admin}",
        "KOPIA_SERVER_PASSWORD": "${KOPIA_SERVER_PASSWORD}",
        "KOPIA_ENABLE_TLS": "${KOPIA_ENABLE_TLS:-false}",
        "KOPIA_TLS_CERT_FILE": "${KOPIA_TLS_CERT_FILE:-}",
        "KOPIA_TLS_KEY_FILE": "${KOPIA_TLS_KEY_FILE:-}",
        "KOPIA_LOG_DEBUG": "${KOPIA_LOG_DEBUG:-false}",
        "KOPIA_DATA_PATH": "${KOPIA_DATA_PATH:-/}"
      },
      "volumes": [
        {
          "hostPath": "${APP_DATA_DIR}/data/config",
          "containerPath": "/app/config"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/cache",
          "containerPath": "/app/cache"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/logs",
          "containerPath": "/app/logs"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/repository",
          "containerPath": "/repository"
        },
        {
          "hostPath": "${APP_DATA_DIR}/data/snapshots",
          "containerPath": "/tmp",
          "options": "shared"
        },
        {
          "hostPath": "/",
          "containerPath": "${KOPIA_DATA_PATH}",
          "options": "ro"
        }
      ],
      "command": [
        "sh",
        "-c",
        "set -e; echo \\\"${KOPIA_PASSWORD}\\\" > /tmp/kopia_pass && chmod 600 /tmp/kopia_pass; FLAGS=\\\"\\\"; if [ \\\"${KOPIA_ENABLE_TLS}\\\" = \\\"true\\\" ]; then FLAGS=\\\"$FLAGS --tls-cert-file=${KOPIA_TLS_CERT_FILE} --tls-key-file=${KOPIA_TLS_KEY_FILE}\\\"; else FLAGS=\\\"$FLAGS --insecure\\\"; fi; [ \\\"${KOPIA_LOG_DEBUG}\\\" = \\\"true\\\" ] && FLAGS=\\\"$FLAGS --log-level=debug\\\"; exec kopia server start $FLAGS --address=0.0.0.0:51515 --server-username=\\\"${KOPIA_SERVER_USERNAME}\\\" --server-password=\\\"${KOPIA_SERVER_PASSWORD}\\\""
      ],
      "logging": {
        "driver": "json-file",
        "options": {
          "max-size": "10m",
          "max-file": "3"
        }
      },
      "networks": {
        "tipi_main_network": {
          "external": true
        }
      },
      "labels": {
        "traefik.enable": "true",
        "traefik.http.middlewares.kopia-web-redirect.redirectscheme.scheme": "https",
        "traefik.http.routers.kopia-insecure.rule": "Host(`${APP_DOMAIN}`)",
        "traefik.http.routers.kopia-insecure.entrypoints": "web",
        "traefik.http.routers.kopia-insecure.middlewares": "kopia-web-redirect",
        "traefik.http.routers.kopia-insecure.service": "kopia",
        "traefik.http.routers.kopia.rule": "Host(`${APP_DOMAIN}`)",
        "traefik.http.routers.kopia.entrypoints": "websecure",
        "traefik.http.routers.kopia.tls.certresolver": "myresolver",
        "traefik.http.routers.kopia.service": "kopia",
        "traefik.http.routers.kopia-local-insecure.rule": "Host(`kopia.${LOCAL_DOMAIN}`)",
        "traefik.http.routers.kopia-local-insecure.entrypoints": "web",
        "traefik.http.routers.kopia-local-insecure.middlewares": "kopia-web-redirect",
        "traefik.http.routers.kopia-local-insecure.service": "kopia",
        "traefik.http.routers.kopia-local.rule": "Host(`kopia.${LOCAL_DOMAIN}`)",
        "traefik.http.routers.kopia-local.entrypoints": "websecure",
        "traefik.http.routers.kopia-local.tls": "true",
        "traefik.http.routers.kopia-local.service": "kopia",
        "runtipi.managed": "true"
      }
    }
  ]
}
